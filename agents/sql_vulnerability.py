import re
from openai import OpenAI

# Point to the local LLM server
client = OpenAI(base_url="http://localhost:1234/v1", api_key="lm-studio")

def find_sql_injections(code):
    """
    Function to find potential SQL injection vulnerabilities in the provided code
    using a local LLM for analysis.
    """
    # Query the local LLM
    completion = client.chat.completions.create(
        model="Qwen/Qwen2.5-Coder-7B-Instruct-GGUF",
        messages=[
            {"role": "system", "content": "Analyze the following Java code and understand the code flow. Identify any potential SQL injection vulnerabilities. Provide a detailed explanation of why the code might be vulnerable, including the specific functions and lines that contribute to the vulnerability. Additionally, suggest remediation steps to fix the identified issues."},
            {"role": "user", "content": code}
        ],
        temperature=0.2,
    )

    # Extract and return the analysis from the LLM response
    vulnerabilities = completion.choices[0].message.content  # Access content using dot notation
    return vulnerabilities
